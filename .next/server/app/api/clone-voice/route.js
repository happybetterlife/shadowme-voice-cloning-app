(()=>{var e={};e.id=592,e.ids=[592],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},4743:(e,o,t)=>{"use strict";t.r(o),t.d(o,{patchFetch:()=>m,routeModule:()=>h,serverHooks:()=>y,workAsyncStorage:()=>v,workUnitAsyncStorage:()=>f});var i={};t.r(i),t.d(i,{POST:()=>p});var a=t(2706),n=t(8203),s=t(5994),l=t(9187),c=t(340);let r="sk_a44152702031b3af9f1a87072171fc9993fdbfb477fba26c",d=new Map;async function p(e){let o;try{console.log("\uD83D\uDEA8 CRITICAL: Voice cloning request received (App Router)..."),console.log("\uD83D\uDEA8 Request method:",e.method),o=await e.json(),console.log("\uD83D\uDEA8 Request body keys:",Object.keys(o)),console.log("\uD83D\uDEA8 Request body size:",JSON.stringify(o).length);let{text:t="Hello, how are you today?",audioData:i,sessionId:a}=o;if(console.log("\uD83D\uDEA8 EXTRACTED DATA:"),console.log("  - text:",t),console.log("  - audioData exists:",!!i),console.log("  - audioData length:",i?i.length:0),console.log("  - sessionId:",a),console.log("\uD83D\uDCDD Text received:",t),console.log("\uD83C\uDFB5 Audio data present:",!!i),console.log("\uD83C\uDFB5 Audio data type:",typeof i),console.log("\uD83C\uDFB5 Audio data length:",i?i.length:0),console.log("\uD83C\uDFB5 Audio data starts with:",i?i.substring(0,50):"N/A"),console.log("\uD83C\uDD94 Session ID:",a),!i||i.length<100)return console.log("❌ No valid audio data provided, using default voice"),console.log("\uD83D\uDD0D Reason: audioData is",i?`too short (${i.length} chars)`:"missing"),await u(t);if(a){let e=d.get(a);if(e&&Date.now()-e.lastUsed<18e5){console.log("⚡ 캐시된 음성 발견! 즉시 TTS 생성:",e.voiceId);let o=await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${e.voiceId}`,{method:"POST",headers:{"xi-api-key":r,"Content-Type":"application/json"},body:JSON.stringify({text:t,model_id:"eleven_multilingual_v2",voice_settings:{stability:.7,similarity_boost:.8,style:.5,use_speaker_boost:!0}})});if(o.ok){e.lastUsed=Date.now(),d.set(a,e);let t=await o.arrayBuffer();return console.log("✅ 캐시된 음성으로 TTS 완료 (초고속)"),new l.NextResponse(t,{headers:{"Content-Type":"audio/mpeg","Content-Disposition":'attachment; filename="cached_cloned_voice.mp3"'}})}console.warn("⚠️ 캐시된 음성으로 TTS 실패, 음성 재생성 필요"),d.delete(a)}else if(e){console.log("\uD83D\uDDD1️ 만료된 캐시 음성 삭제:",a),d.delete(a);try{await fetch(`https://api.elevenlabs.io/v1/voices/${e.voiceId}`,{method:"DELETE",headers:{"xi-api-key":r}})}catch(e){console.warn("음성 정리 실패:",e)}}}let n=Buffer.from(i.split(",")[1],"base64");console.log("\uD83D\uDCC1 Audio data received, size:",n.length),console.log("\uD83E\uDDEC Creating voice clone with ElevenLabs..."),console.log("\uD83D\uDCCA Environment check:"),console.log("  - Runtime:","undefined"!=typeof process?"Node.js":"Browser"),console.log("  - Platform:","undefined"!=typeof process?process.platform:"Unknown"),console.log("  - Memory usage:","undefined"!=typeof process&&process.memoryUsage?process.memoryUsage():"Unknown");let s=new FormData;s.append("name",`user_voice_${Date.now()}`),s.append("description","User voice for pronunciation learning");let p="mp3",h="audio/mp3",v=i.split(",")[0];v.includes("audio/webm")?(p="webm",h="audio/webm"):v.includes("audio/mp4")?(p="mp4",h="audio/mp4"):v.includes("audio/aac")&&(p="aac",h="audio/aac"),console.log("\uD83C\uDFB5 Detected audio format:",{mimeType:h,fileExtension:p});let f=new Blob([n],{type:h});s.append("files",f,`recording.${p}`);let y=await fetch("https://api.elevenlabs.io/v1/voices/add",{method:"POST",headers:{"xi-api-key":r},body:s});if(!y.ok){let e=await y.text();if(console.error("❌ Voice cloning failed:",e),e.includes("voice_limit_reached")){console.log("\uD83E\uDDF9 Voice limit reached, attempting to clean up old voices..."),await g(),console.log("\uD83D\uDD04 Retrying voice cloning after cleanup...");let e=await fetch("https://api.elevenlabs.io/v1/voices/add",{method:"POST",headers:{"xi-api-key":r},body:s});if(e.ok){let o=(await e.json()).voice_id;console.log("✅ Voice cloned successfully after cleanup! Voice ID:",o);let i=await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${o}`,{method:"POST",headers:{"xi-api-key":r,"Content-Type":"application/json"},body:JSON.stringify({text:t,model_id:"eleven_multilingual_v2",voice_settings:{stability:.7,similarity_boost:.8,style:.5,use_speaker_boost:!0}})});if(i.ok){let e=await i.arrayBuffer();try{await fetch(`https://api.elevenlabs.io/v1/voices/${o}`,{method:"DELETE",headers:{"xi-api-key":r}}),console.log("\uD83D\uDDD1️ Temporary voice cleaned up immediately")}catch(e){console.warn("Failed to delete voice:",e)}return new l.NextResponse(e,{headers:{"Content-Type":"audio/mpeg","Content-Disposition":'attachment; filename="cloned_voice.mp3"'}})}}}return await u(t)}let m=(await y.json()).voice_id;console.log("✅ Voice cloned successfully! Voice ID:",m),a?(d.set(a,{voiceId:m,createdAt:Date.now(),lastUsed:Date.now(),sampleText:t}),console.log("\uD83D\uDCBE 세션 음성 캐시에 저장:",a,"->",m),console.log("\uD83D\uDCCA 현재 캐시된 세션들:",Array.from(d.keys())),(0,c.ki)(a,m,t)):console.warn("⚠️ sessionId가 없어서 캐시에 저장하지 못했습니다!"),console.log("\uD83D\uDDE3️ Generating speech with cloned voice...");let w=await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${m}`,{method:"POST",headers:{"xi-api-key":r,"Content-Type":"application/json"},body:JSON.stringify({text:t,model_id:"eleven_multilingual_v2",voice_settings:{stability:.7,similarity_boost:.8,style:.5,use_speaker_boost:!0}})});if(!w.ok){let e=await w.text();console.error("❌ TTS with cloned voice failed:",e);try{await fetch(`https://api.elevenlabs.io/v1/voices/${m}`,{method:"DELETE",headers:{"xi-api-key":r}})}catch(e){console.warn("Failed to delete voice:",e)}return await u(t)}let b=await w.arrayBuffer();return console.log("\uD83C\uDF89 Voice cloning completed successfully!"),console.log("\uD83D\uDCBE 음성 캐시에 보관됨 (30분 후 자동 정리)"),new l.NextResponse(b,{headers:{"Content-Type":"audio/mpeg","Content-Disposition":'inline; filename="cloned_voice.mp3"',"Access-Control-Allow-Origin":"*","Accept-Ranges":"bytes"}})}catch(e){return console.error("\uD83D\uDCA5 Voice cloning error:",e),await u(o?.text||"Hello, how are you today?")}}async function u(e){try{console.log("\uD83D\uDD04 Using default voice fallback...");let o=await fetch("https://api.elevenlabs.io/v1/text-to-speech/21m00Tcm4TlvDq8ikWAM",{method:"POST",headers:{"xi-api-key":r,"Content-Type":"application/json"},body:JSON.stringify({text:e,model_id:"eleven_monolingual_v1",voice_settings:{stability:.7,similarity_boost:.8}})});if(o.ok){let e=await o.arrayBuffer();return new l.NextResponse(e,{headers:{"Content-Type":"audio/mpeg","Content-Disposition":'inline; filename="fallback_voice.mp3"',"Access-Control-Allow-Origin":"*","Accept-Ranges":"bytes"}})}{let e=await o.text();console.error("❌ Fallback voice generation failed:",e)}}catch(e){console.error("\uD83D\uDCA5 Fallback voice generation failed:",e)}return l.NextResponse.json({error:"All voice generation methods failed"},{status:500})}async function g(){try{console.log("\uD83D\uDD0D Fetching current voices...");let e=await fetch("https://api.elevenlabs.io/v1/voices",{headers:{"xi-api-key":r}});if(e.ok){let o=(await e.json()).voices.filter(e=>e.name.startsWith("user_voice_")&&"cloned"===e.category);for(let e of(console.log(`🎯 Found ${o.length} user voices to clean up`),o.slice(0,-2)))try{await fetch(`https://api.elevenlabs.io/v1/voices/${e.voice_id}`,{method:"DELETE",headers:{"xi-api-key":r}}),console.log(`🗑️ Deleted old voice: ${e.name}`)}catch(o){console.warn(`Failed to delete voice ${e.name}:`,o)}console.log("✅ Cleanup completed")}}catch(e){console.error("❌ Cleanup failed:",e)}}setInterval(function(){let e=Date.now(),o=[];for(let[t,i]of d)e-i.lastUsed>18e5&&(o.push(t),fetch(`https://api.elevenlabs.io/v1/voices/${i.voiceId}`,{method:"DELETE",headers:{"xi-api-key":r}}).catch(e=>console.warn("음성 삭제 실패:",e)));o.forEach(e=>{d.delete(e),console.log("\uD83D\uDDD1️ 만료된 세션 정리:",e)}),o.length>0&&console.log(`✅ ${o.length}개 만료된 세션 정리 완료`)},6e5);let h=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/clone-voice/route",pathname:"/api/clone-voice",filename:"route",bundlePath:"app/api/clone-voice/route"},resolvedPagePath:"/Users/joy/Desktop/figma_local/ShadowME - AI Voice Cloning Language Learning App/shadowme-nextjs/app/api/clone-voice/route.ts",nextConfigOutput:"",userland:i}),{workAsyncStorage:v,workUnitAsyncStorage:f,serverHooks:y}=h;function m(){return(0,s.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:f})}},6487:()=>{},8335:()=>{},340:(e,o,t)=>{"use strict";t.d(o,{E1:()=>s,ki:()=>a,po:()=>n});let i=new Map;function a(e,o,t){i.set(e,{voiceId:o,createdAt:Date.now(),sampleText:t}),console.log(`💾 Cached voice clone for session ${e}: ${o}`)}function n(e){return i.get(e)}function s(){return Array.from(i.keys())}}};var o=require("../../../webpack-runtime.js");o.C(e);var t=e=>o(o.s=e),i=o.X(0,[989,452],()=>t(4743));module.exports=i})();